---
title: Setup the Backend side
description: Learn how to setup the Backend side of a Weave.js app on Next.js
---

## Introduction

In order to make the backend functional, we need to setup a Next.js
[custom server](https://nextjs.org/docs/14/pages/building-your-application/configuring/custom-server)
to later on integrate Weave.js Websockets store, the store will handle for Us
the shared-state management, clients networking, persistence and awareness events.

## Backend setup

To setup Weave.js backend over our Next.js project (on a single artifact), we need
to fully complete this steps:

<div className="fd-steps">

<div className="[&_h3]:fd-step">
 
### Install the Weave.js backend dependencies

First lets install the **Weave.js** websocket store dependencies, on your root project folder,
execute the following command:

```shell
npm install ws @inditextech/weave-store-websockets
```

</div>

<div className="[&_h3]:fd-step">
 
### Setup the Next.js custom server

In order to have a frontend and backend on the same artifact on top of Next.js we need to implement
a [custom server](https://nextjs.org/docs/14/pages/building-your-application/configuring/custom-server)
on Next.js, and later on include the necessary Weave.js backend logic.

<Callout title="Not recommended for production" type="warn">
  For production environments, you should consider using a separate backend server to
  handle the Weave.js backend logic.

</Callout>

#### Dependencies installation

To start, lets install the necessary dependencies for the custom server with the following commands:

- Dependencies needed on runtime:

```shell
npm install cross-env express
```

- Dependencies only needed on LDE or build time:

```shell
npm install -D ts-node nodemon @types/express
```

#### TypeScript configuration

<Callout title="Nodemon" type="note">
  This sections uses [nodemon](https://www.npmjs.com/package/nodemon) a tool
  that helps on the LDE by automatically restarting the underlying Node.js
  application when a file changes.
</Callout>

Second, we need to setup the the TypeScript configuration for the server part.

- Create a `tsconfig.server.json` file on the root of your project with the following content:

  <include lang="json" meta='title="tsconfig.server.json"'>
    ../../examples/manual-installation/tsconfig.server.json
  </include>

- Setup the transpilation of the server files from TypeScript to JavaScript. Create a
  `nodemon.json` file on the root of your project with the following content:

  <include lang="json" meta='title="nodemon.json"'>
    ../../examples/manual-installation/nodemon.json
  </include>

#### Custom server logic

<Callout title="Nodemon" type="note">
  This sections uses [Express](https://expressjs.com) a web framework for
  Node.js as the underlying server for the custom server.
</Callout>

Define the custom server logic by creating a file named `server.ts` on the root of your project
with the following content:

<include lang="ts" meta='title="tsconfig.server.json"'>
  ../../examples/manual-installation/server.ts
</include>

#### Custom server tooling

In order to properly use the custom server on: the LDE and when building the application,
we need to customize the dependant scripts on your `package.json`: the `dev`, `build` and `start` ones.
Change the scripts definitions with the following content:

```json
{
  ...
  "scripts": {
    ...
    "dev": "next dev --turbo", // [!code --]
    "dev": "nodemon", // [!code ++]
    "build": "next build", // [!code --]
    "build": "next build && tsc --project tsconfig.server.json", // [!code ++]
    "start": "next start", // [!code --]
    "start": "cross-env NODE_ENV=production node dist/server.js" // [!code ++]
    ...
  },
  ...
}
```

Finally lets test that the Next.js project keeps starting with the new custom server configuration,
on the project root folder just run the following command:

```shell
npm run dev
```

Navigate to http://localhost:3000 on a browser, you should still see the Next.js default application running
and the console should have no errors at all.

</div>

<div className="[&_h3]:fd-step">
 
### Integrate Weave.js into the backend

Now the Next.js custom server is completely setup, lets proceed to add the necessary Weave.js
backend logic for that we will use the xref:api-reference:stores/websockets/index.adoc[Websockets store] library
(`@inditextech/weave-store-websockets`). We just only need to:

- Define how to handle the persistence of the shared-state.
- Instantiate the xref:api-reference:stores/websockets/server.adoc#weave-websockets-server[WeaveWebsocketsServer] class from
  the library `@inditextech/weave-store-websockets` and configure it.

#### Setup the shared-state persistence handlers

On this step we're going to define the persistence logic for the shared-state. For our quickstart we'll
use the file system as our persistence layer.

Create a `persistence.ts` file on the project root and set it's content to:

<include lang="ts" meta='title="persistence.ts"'>
  ../../examples/manual-installation/persistence.ts
</include>

File explanation:

- **`(1)`**: Import necessary Node.js dependencies to handle the file system.
- **`(2)`**: `fetchRoom` function fetches a previously saved shared-state of a room by its ID from the file system.
- **`(3)`**: `persistRoom` function persist the shared-state of a room by its ID onto the file system.

#### Setup the Weave.js Websockets store

Finally lets setup the Weave.js store handler, in this case we'll setup the Websockets transport.

On the custom server file `server.ts`, let's add the necessary logic to use the `@inditextech/weave-store-websockets`
store handler. You can replace the contents of `server.ts` with this content:

<include lang="ts" meta='title="server.ts"'>
  ../../examples/manual-installation/server.mod-1.ts
</include>

Changes explanation:

- **`(1)`**: Import **Weave.js** Websockets store dependency.
- **`(2)`**: Import persistence handlers previously defined.
- **`(3)`**: Define a regex to identify the **Weave.js** Websockets connection URI.
- **`(4)`**: Extract the underlying HTTP server.
- **`(5)`**: Define the configuration for the xref:api-reference:stores/websockets/server.adoc#weave_websockets_server[WeaveWebsocketsServer] class.
- **`(6)`**: Define the property `performUpgrade`, this indicates which URIs are valid for the Websocket upgrade protocol
  (upgrade from HTTP to WEBSOCKETS)
- **`(7)`**: Define the property `extractRoomId`, this indicates how to extract the room ID from the Websocket connection URI.
- **`(8)`**: Use the previous `fetchRoom` function for persistence management.
- **`(9)`**: Use the previous `persistRoom` function for persistence management.
- **`(10)`**: Instantiate the xref:api-reference:stores/websockets/server.adoc#weave_websockets_server[WeaveWebsocketsServer] class.
- **`(11)`**: Attach the **Weave.js** Websockets server to the HTTP server.

Finally lets test that the project keeps starting with the changes made to the custom server, just run
the following command:

```shell
npm run dev
```

Navigate to http://localhost:3000 on a browser, you should still see the Next.js default application running
and the console should have no errors at all.

</div>

</div>

### Next steps

Let's now [setup the Frontend side](/docs/main/manual-installation/frontend) of the application.
